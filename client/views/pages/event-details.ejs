<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
  <script>
    $(document).ready(function() {

      var id = getUrlParam('id');
      console.log("Getting event details with id: " + id);

      getEventById(id)
        .then(entry => {
          let row = `
            <div class="row">
              <div id="row-${id}" class="col-md-6">
                <h3><span class="glyphicon glyphicon-flash"></span> <a href="/event-details?id=${entry.id}">${entry.title}</a></h3>
                <span>Spots: ${entry.spots}</span><br/>
                <span>Registration due date: ${formatDateOf(entry.registrationDueDate)}</span><br/>
                <span>Event date: ${formatDateOf(entry.eventDate)}</span><br/>
                <span>Organizer: ${entry.organizer}</span><br/>
              </div>
              <hr/>
            </div>
          `;

          $(row).appendTo($("#event-details"));

          if (ethereum.selectedAddress.toLowerCase() == entry.organizer.toLowerCase()) {
            $('<span style="margin-top: 10px;">You are organizer</span>').appendTo($('#row-' + entry.id));
          } else {
            isRegisteredForEntry(id).then(isRegistered => {
              if (isRegistered) {
                $('<span style="margin-top: 10px;">Already registered</span>').appendTo($('#row-' + id));
              } else {
                var button = `<button id="register-button-${id}">Register</button>`;
                $(button).appendTo($('#row-' + id));
                $('#register-button-' + entry.id).click(function() {
                  var eventId = $(this).attr('id').split('-')[2];
                  registerForEvent(eventId)
                    .then(result => {
                      alert("Registered event: " + result);
                      window.location = '/open-events';
                    })
                    .catch(err => {
                      alert(err.message);
                    });
                });
              }
            });
          }
        })
        .catch(err => {
          let alert = $('<div class="alert alert-info text-center" role="alert">Event not found or not on chain yet. Try again later</div>');
          alert.css('color', 'red');
          alert.appendTo($("#event-details"));
        });

    });
  </script>
</head>

<body>

  <%- include ("../partials/nav.ejs") %>

  <div class="container">
    <div id="mm-status" class="alert alert-info text-center" role="alert"></div>
    <hr>
    <div id="event-details"></div>

    <%- include ("../partials/footer.ejs") %>

  </div>

</body>
</html>
